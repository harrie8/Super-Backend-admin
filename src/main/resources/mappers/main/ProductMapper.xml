<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sppart.admin.product.domain.mapper.ProductMapper">

    <resultMap id="productWithTagsByCondition" type="com.sppart.admin.product.dto.ProductWithTagsDto">
        <id column="product_id" property="productId"/>
        <result column="title" property="title"/>
        <result column="artist_name" property="artistName"/>
        <result column="description" property="description"/>
        <result column="price" property="price"/>
        <collection property="tags" ofType="string">
            <result column="tagName"/>
        </collection>
    </resultMap>

    <!--    todo 등록일자로 정렬되게 수정하기 -->
    <select id="findProductsWithTagsByCondition"
            parameterType="com.sppart.admin.product.dto.ProductSearchCondition"
            resultMap="productWithTagsByCondition">
        SELECT prod.product_id,
        prod.title,
        prod.artist_name,
        prod.description,
        prod.price,
        t.name AS tagName
        FROM product AS prod
        INNER JOIN product_with_tag AS pwt ON pwt.product_id = prod.product_id
        INNER JOIN tag AS t ON t.tag_id = pwt.tag_id
        <where>
            <if test="condition.title != null and condition.title != ''">
                AND prod.title = #{condition.title}
            </if>
            <if test="condition.artistName != null and condition.artistName != ''">
                AND prod.artist_name = #{condition.artistName}
            </if>
            <if test="condition.productId != null and !condition.productId.equals('')">
                AND prod.product_id = #{condition.productId};
            </if>
        </where>
    </select>

    <select id="countAll" resultType="int">
        SELECT COUNT(*)
        FROM exhibition;
    </select>

    <delete id="bulkDeleteByIds">
        <if test="ids != null and !ids.isEmpty()">
            DELETE
            FROM exhibition
            <where>
                AND exhibition_id IN
                <foreach collection="ids" item="id" open="(" separator="," close=")">
                    #{id}
                </foreach>
            </where>
        </if>
    </delete>

    <select id="findById" resultType="com.sppart.admin.exhibition.domain.entity.Exhibition">
        SELECT *
        FROM exhibition
        WHERE exhibition_id = #{exhibitionId};
    </select>

    <resultMap id="findByIdWithParticipatedProductsMap"
               type="com.sppart.admin.exhibition.dto.ExhibitionWithParticipatedProducts">
        <id column="exhibition_id" property="exhibitionId"/>
        <result column="title" property="title"/>
        <result column="subHeading" property="subHeading"/>
        <result column="location" property="location"/>
        <result column="start_date" property="startDate"/>
        <result column="end_Date" property="endDate"/>
        <result column="status" property="status"/>
        <result column="poster" property="poster"/>
        <collection property="products" ofType="com.sppart.admin.product.dto.ProductForSpecificExhibition">
            <id column="product_id" property="productId"/>
            <result column="product_title" property="title"/>
            <result column="basic_view" property="basicView"/>
            <result column="qr_view" property="qrView"/>
            <result column="like_count" property="likeCount"/>
            <result column="order_count" property="orderCount"/>
        </collection>
    </resultMap>

    <select id="findByIdWithParticipatedProducts" parameterType="Long" resultMap="findByIdWithParticipatedProductsMap">
        SELECT exhi.exhibition_id,
               exhi.title,
               exhi.subHeading,
               exhi.start_date,
               exhi.end_Date,
               exhi.location,
               exhi.status,
               exhi.poster,
               pro.product_id AS product_id,
               pro.title      AS product_title,
               pro.basic_view,
               pro.qr_view,
               pro.like_count,
               pro.order_count
        FROM exhibition AS exhi
                 LEFT OUTER JOIN product_exhibition AS pe ON pe.exhibition_id = exhi.exhibition_id
                 LEFT OUTER JOIN product AS pro ON pro.product_id = pe.product_id
        WHERE exhi.exhibition_id = #{exhibitionId};
    </select>

    <insert id="save" parameterType="com.sppart.admin.exhibition.domain.entity.Exhibition" useGeneratedKeys="true"
            keyProperty="id">
        INSERT INTO exhibition(title, subHeading, start_date, end_date, location, status, poster, is_display)
        VALUES (#{title}, #{subHeading}, #{startDate}, #{endDate}, #{location}, #{status}, #{poster}, #{isDisplay});
    </insert>
</mapper>